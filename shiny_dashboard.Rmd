---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(rvest)
library(plotly)
library(viridis)
library(shiny)
```

```{r data import}
cost_df = read.csv("data/insurance_medical_cost_personal_datasets.csv")

cost_df = cost_df %>% 
  mutate(
    smoker = ifelse(smoker == "yes", 1, 0),
    smoker = as.factor(smoker),
    sex = ifelse(sex == "male", 1, 2),
    sex = as.factor(sex),
    children = as.factor(children),
    age_group = case_when(age < 18 ~ 1, 
                          age >= 18 & age < 24 ~ 2,
                          age >= 25 & age < 44 ~ 3,
                          age >= 45 & age < 64 ~ 4,
                          age >= 65 ~ 5
                          ),
    age_group = as.factor(age_group),
    
    bmi_group = case_when(bmi < 20 ~ 1, 
                          bmi >= 20 & bmi < 30 ~ 2,
                          bmi >= 30 & bmi < 40 ~ 3,
                          bmi >= 40 & bmi < 50 ~ 4,
                          bmi >= 50 ~ 5
                          ),
    bmi_group = as.factor(bmi_group),
    
    children_group = ifelse(children == 0, 0, 1),
    children_group = as.factor(children_group)
     
    ) %>% 
    na.omit()

```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
min_age = 
  cost_df %>% 
  distinct(age) %>% 
  min()

max_age = 
  cost_df %>% 
  distinct(age) %>% 
  max()
  
sliderInput(
  "age_choice",
  label = h3("Age"),
  min = min_age,
  max = 100,
  value = c(30)
)

min_bmi = 
  cost_df %>% 
  distinct(bmi) %>% 
  min()

max_bmi = 
  cost_df %>% 
  distinct(bmi) %>% 
  max()

sliderInput(
  "BMI_choice",
  label = h3("BMI"),
  min = min_bmi,
  max = max_bmi,
  value = c(20)
)
radioButtons(
  "smoke_or_not",
  label = h3("Smoke or not"),
  choices = c("Yes", "No"),
  selected = "Yes"
)
radioButtons(
  "have_kids_or_not",
  label = h3("Have kids or not"),
  choices = c("Y", "N"),
  selected = "Y"
)
```
Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}
renderPlotly({
  
  predict_data = tibble(smoker = "1",
                      children_group = "1",
                      age = input[["age_choice"]],
                      bmi = input[["bmi_choice"]]
                      ) %>% 
  mutate(smoker = if_else(input[["smoke_or_not"]] == "Yes",smoker, "0"),
         children_group = if_else(input[["have_kids_or_not"]] == "Yes", children_group, "0")) %>% 
    plot_ly(x = age, y = bmi, type = "histogram", color = ~age, alpha = .5)
  
})
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
renderPlotly({
cost_df_out = cost_df[-c(544,578, 1301),]
cost_df_log = cost_df_out %>% 
  mutate(
    Lncharges = log(charges)
  ) 
model_log = lm(Lncharges ~ smoker + children_group + age + bmi, data = cost_df_log) 

predict_data = tibble(smoker = "1",
                      children_group = "1",
                      age = input[["age_choice"]],
                      bmi = input[["bmi_choice"]]
                      ) %>% 
  mutate(smoker = if_else(input[["smoke_or_not"]] == "Yes",smoker, "0"),
         children_group = if_else(input[["have_kids_or_not"]] == "Yes", children_group, "0"))

result = predict(model_log,predict_data,interval = "confidence") %>% 
  as_tibble() %>% 
  mutate(
    fit = exp(fit),
    lwr = exp(lwr),
    upr = exp(upr)
  ) %>% 
  mutate(x = "1") %>%
  ggplot(aes(x, fit)) + 
  ylim(10000,60000) +
  geom_point(shape = 21, size = 3, fill = "white") +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  geom_vline(xintercept = "1", color = "black", size = 1.2) +
  coord_flip() 
ggplotly(result)
})
```
