---
title: "Insurance cost analysis"
output: html_document
---

```{r, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(ggcorrplot)
library(olsrr)
library(MASS) # boxcox

```


```{r}
cost_df = read.csv("data/insurance_medical_cost_personal_datasets.csv")

cost_df = cost_df %>% 
  mutate(
    smoker = ifelse(smoker == "yes", 1, 0),
    smoker = as.factor(smoker),
    sex = ifelse(sex == "male", 1, 2),
    sex = as.factor(sex),
    children = as.factor(children),
    age_group = case_when(age < 18 ~ 1, 
                          age >= 18 & age < 24 ~ 2,
                          age >= 25 & age < 44 ~ 3,
                          age >= 45 & age < 64 ~ 4,
                          age >= 65 ~ 5
                          ),
    age_group = as.factor(age_group),
    
    bmi_group = case_when(bmi < 20 ~ 1, 
                          bmi >= 20 & bmi < 30 ~ 2,
                          bmi >= 30 & bmi < 40 ~ 3,
                          bmi >= 40 & bmi < 50 ~ 4,
                          bmi >= 50 ~ 5
                          ),
    bmi_group = as.factor(bmi_group),
    
    children_group = ifelse(children == 0, 0, 1),
    children_group = as.factor(children_group)
     
    ) %>% 
    na.omit()

```

<br>

## Model Building 

<br>

### Model selection

**Correlation plot and information about each variable**

```{r}

cost_df_cor = cost_df %>% 
  dplyr::select(age, sex, bmi, smoker, charges, children_group)

model.matrix(~0+., data = cost_df_cor) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=2)

```


```{r}
var <- c("smoker", "children_group", "sex", "age", "bmi", "charges")

var_meaning <- c("0 = non-smoker, 1 = smoker", "0 = No children, 1 = Have at least 1 child", "1 = male, 2 = female", "Age range from 18 to 63", "Body mass index range from 15.96 to 53.13", "Cost of health insurance")

var_info <- data.frame(var, var_meaning) %>% 
  rename(
    "Variable name" = var,
    "Variable information" = var_meaning
  )
knitr::kable(var_info)
```

There is no collinearity between any of the variables. Therefore, no need to adjust variable for model building. In addition, smoking seems to be the highest correlated variable to charges among other variables.

<br>

**Fit regression using all predictors**

```{r}
model <- lm(charges ~ smoker + children_group + sex + age + bmi, data = cost_df)
summary(model)%>% 
  broom::tidy() %>% 
  knitr::kable()
```

The model building result shows that sex is not a significant variable with p-valur > 0.05. Therefore, when we do the stepwise regression, we would likely to remove the variable of sex.

<br>

**Stepwise regression**

```{r}
step(model, direction='both')

```

The stepwise regression process confirm that sex is not significant variable.

<br>

**Here is the final model with significant variables:**

```{r}
model1 <- lm(charges ~ smoker + children_group + age + bmi, data = cost_df)
summary(model1) %>% 
  broom::tidy() %>% 
  knitr::kable()
```

<br>

### Model diagnostic
```{r}
par(mfrow = c(1,1))
plot(model1, which = 1)
```

The graph above did not show homoscedasticity of residual. Therefore, we need to transform the model.

<br>

### Model transformation##

**Box-Cox Transformation**

```{r}
boxcox(model1, lambda = seq(-3, 3, by = 0.25)) 
```

Since lamda = 0, try natural log transformation.

<br>

**Before transformation, remove outliers first**

```{r}
plot(model1, which = 4) # remove 544, 578, 1301

cost_df_out = cost_df[-c(544,578, 1301),]

```

The outliers are rows 544, 578, 1301. Following model building will use dataset without these outliers.

<br>
**Transform charges to ln(charges)**

```{r}
cost_df_log = cost_df_out %>% 
  mutate(
    Lncharges = log(charges)
  ) 

# fit multivariate model with log transform
model_log = lm(Lncharges ~ smoker + children_group + age + bmi, data = cost_df_log) 

# check diagnostics
boxcox(model_log)

```

<br>
**Diagnostic for natural log transformed model**

```{r}
plot(model_log, which = 1)
```

Lamda is near 1 now, and the residual distribution improved from untransformed data. We conclude this model is suitable.

<br>

###The final model**

```{r}
summary(model_log) %>% 
  broom::tidy() %>% 
  knitr::kable()
```



