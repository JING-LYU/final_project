---
title: "Medical cost analysis"
output: html_document
---

```{r, echo = FALSE, message=FALSE}
library(tidyverse)
library(ggcorrplot)
library(olsrr)

```


```{r, echo = FALSE}
cost_df = read.csv("data/insurance_medical_cost_personal_datasets.csv")
```


```{r, echo = FALSE}
cost_df = cost_df %>% 
  mutate(
    smoker = ifelse(smoker == "yes", 1, 0),
    smoker = as.factor(smoker),
    sex = ifelse(sex == "male", 1, 2),
    sex = as.factor(sex),
    children = as.factor(children),
    age_group = case_when(age < 18 ~ 1, 
                          age >= 18 & age < 24 ~ 2,
                          age >= 25 & age < 44 ~ 3,
                          age >= 45 & age < 64 ~ 4,
                          age >= 65 ~ 5
                          ),
    age_group = as.factor(age_group),
    
    bmi_group = case_when(bmi < 20 ~ 1, 
                          bmi >= 20 & bmi < 30 ~ 2,
                          bmi >= 30 & bmi < 40 ~ 3,
                          bmi >= 40 & bmi < 50 ~ 4,
                          bmi >= 50 ~ 5
                          ),
    bmi_group = as.factor(bmi_group),
    
    children_group = ifelse(children == 0, 0, 1),
    children_group = as.factor(children_group)
     
    ) %>% 
    na.omit()
    
  
```

## Study of factors that affect charge of insurance {.tabset}

### Smoker

```{r}
ggplot(cost_df, aes(x = smoker, y = charges, color = smoker)) + 
  geom_boxplot() + 
  coord_flip()
```

YES! Smoker have significantly higher insurance cost than non smoker.

### Having Children 

```{r, echo = FALSE}
ggplot(cost_df, aes(x = children_group, y = charges, color = children_group)) + 
  geom_boxplot() + 
  coord_flip()
```

$H_0$: mean charges of insurance for having or not having children is the same.

$H_1$: mean charges of insurance for having children is higher than not having children.

```{r}
var.test(charges ~ children_group, data = cost_df)
#Equal variance
children_res <- t.test(charges ~ children_group, data = cost_df, var.equal = TRUE, alternative = "less")
children_res
```

At 0.05 significant level, we reject the null hypothesis and conclude that mean charges of insurance for having children is higher than not having children.

### sex
```{r}
ggplot(cost_df, aes(x = sex, y = charges, color = sex)) + 
  geom_boxplot() + 
  coord_flip()
```

$H_0$: mean charges of insurance for male and female is the same.

$H_1$: mean charges of insurance for male and female is different.

```{r}
var.test(charges ~ sex, data = cost_df)
#Equal variance
sex_res <- t.test(charges ~ sex, data = cost_df, var.equal = FALSE)
sex_res
sex_res <- t.test(charges ~ sex, data = cost_df, var.equal = FALSE, alternative = "less")
sex_res
```

At 0.05 significant level, we reject the null hypothesis and conclude that mean charges of insurance for male and female are different. In fact, male have higher mean cost than female. This is quiet counter-intuitive.


### age


```{r}
ggplot(cost_df, aes(x = age, y = charges)) + 
  geom_smooth() 

```

It is clear from the plot that higher age have higher cost of insurance.

### bmi 

```{r, echo = FALSE}
ggplot(cost_df, aes(x = bmi, y = charges)) + 
  geom_smooth() 
```

It is clear from the plot that higher bmi have higher cost of insurance.


### conclusion

Variables that affect charge of insurance: `smoking`, `whether or not having children`, `sex`, `age`, `bmi`.

### collinearity examination

```{r}
#model <- glm(charges ~ smoker + children_group + sex + age + bmi, data = cost_df)

cost_df_cor = cost_df %>% 
  select(age, sex, bmi, smoker, charges, children_group)



model.matrix(~0+., data=cost_df_cor) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=2)
```

There is no collinearity between any of the variables.



