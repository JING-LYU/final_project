---
title: "Final Report"
authors: "Jing Lyu, Mengfan Luo, Yushan Wang, Yiqun Jin"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---
```{r, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(warning = FALSE)
library(tidyverse)
library(ggcorrplot)
library(olsrr)
library(MASS)
library(plotly)
library(plyr)
library(leaflet)
library(rvest)
library(httr)
library(haven)

```

<br>

## Motivation

We notice that a lot of smokers complain about their insurance charges. In fact, it is known that the health insurance companies stratify smokers and non-smokers and assign different insurance prices according to smoking status. 

Since health insurance is vital for peopleâ€™s well-being, and the cost is the main reason that stops people from buying insurance, we are interested in exploring the relationship between smoking and health insurance. To be specific, our research topic can be divided into three research questions.We would like to investigate:

* If smokers tend to get insurance; 
* What type of insurance they prefer; 
* Factors that affect insurance cost. 

Another reason that limits access to insurance is lack of information. As such, mapping of health consulting centers, health insurance carriers locations, and medicaid provider location in NYC, along with their contact information and operation hours, are also provided for readers who need more information for insurance and health advice.

<br>


## Related work 

The [Health Market website](https://www.healthmarkets.com/content/smoking-and-health-insurance) introduced the idea of **tobacco rating**. Tobacco rating is the practice of charging tobacco users more for health insurance. In fact, the charge for smokers can be up to 50% more than non-smokers, which lead us to consider if smokers would be frustrated to purchase insurance. 

In addition, there are many tweets on twitter that discuss the relationship between smoking and health insurance. We have read that smokers lose access to many health resources due to higher cost of insurance, and insurance won't approve as many treatments for smokers as non-smokers.

These facts inspired us to look deep into the relationship between smoking and health insurance.

<br>


## Initial questions

We divide our main research topic, the relationship between smoking and health insurance, into two parts: 

* Smoker insurance preferences: If smokers tend to get insurance and what type of insurance they prefer
* Insurance charges prediction: personal factors that affect insurance cost. 

In the first part, insurance preferences, we first explore people's insurance preferences and their smoking status in order to investigate if there is potential association between smoking and insurance. We also investigate some other variables that could be potential confounders or interaction factors between the relationship of smoking and insurance.

The second part, Insurance charges, assists our main research topic, since we can use the factors (age, bmi, smoker, etc) to not only explain what kind of personal characteristics would affect insurance cost, but also build a prediction model for health insurance charges. By doing such, we would gain better insights to the underlying relationship between health insurance and smoking, along with other important variables that contributes to the cost variation of insurance.

<br>


## Data


### Data source

#### Datasets for analysis

* [Community Health Survey Public Use Data](https://www1.nyc.gov/site/doh/data/data-sets/community-health-survey-public-use-data.page). This dataset contains survey questions regarding smoking and health insurance. We extracted related questions from the survey for analysis.

* [Medical Cost Personal Dataset](https://www.kaggle.com/mirichoi0218/insurance). This dataset sheds lights on insurance charges for different personal characteristics, such as smoking, age, bmi, region, etc.

#### Datasets for mapping

* [Primary Care Access and Planning - Health Insurance Enrollment](https://data.cityofnewyork.us/Health/Primary-Care-Access-and-Planning-Health-Insurance-/gfej-by6h). This dataset is used for mapping of health consulting centers in NYC. 

* [Medicaid Enrolled Provider Listing](https://health.data.ny.gov/Health/Medicaid-Enrolled-Provider-Listing/keti-qx5t): This dataset is used for mapping of Medicaid provide locations in NYC.

* In addition, locations of major health insurance carriers in NYC is collected manually and used to create interactive mapping of these carriers.

### Data cleaning

For **Community Health Survey Public Use Data**, we select year 2014-2016 and variables relating to smoking, insurance, and basic health and economic status. The resulting dataset, consists of roughly 28000 participants and includes the following 12 variables:

**Insurance related**

* `insuredgateway`: Whether having health insurance (1=Yes, 2=No) 

* `insure`: Type of health insurance coverage 

(1=Employer, 2=Self-purchase,3=Medicare,4=Medicaid/Family Health+,5=Milit/CHAMPUS/Tricare,6=COBRA/Other,7=Uninsured)


**Smoking related**

* `smoker`: Smoking status (1= Never, 2= Current, 3= Former)

* `everyday`: Smoking frequency (1 = everyday smoker, 2 = casual smoker)

* `numberperdaya`:  Average cigarettes smoked per day

* `cost20cigarettes`: Cost of 20 cigarettes (one pack)

**Health and economic status**

* `agegroup`: Age groups (1=18-24yrs,2=25-44 yrs,3=45-64 yrs,4=65+ yrs)

* `generalhealth`: Self-evaluated general health status 
 
 (1=Excellent,2=Very good,3=Good,4=Fair,5=Poor)

* `sex`: Participant's sex (1= male, 2= female)

* `bmi`: Participant's BMI ($kg/m^2$)

* `child`: Number of children the participant have: (1= yes, 0= no)

* `imputed_povertygroup`: Federal poverty level(FPL) for the household 

(1= <100% FPL, 2=100 - <200% FPL, 3=200 - <400% FPL, 4=400 - <600% FPL, 5= >600% FPL)


```{r}

chs16 = read_sas("data/chs2016_public.sas7bdat")

chs16_filter = chs16 %>% 
  dplyr::select(agegroup,generalhealth,insuredgateway16,insure16,insured,insure5,sickadvice16,sickplace,didntgetcare16,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup ,bmi,child,sex) %>% 
  mutate(year = 2016) %>% 
  dplyr::rename(insuredgateway = insuredgateway16, insure = insure16,sickadvice = sickadvice16,didntgetcare = didntgetcare16)


chs15 = read_sas("data/chs2015_public.sas7bdat")

chs15_filter = chs15 %>% 
  dplyr::select(agegroup,generalhealth,insuredgateway15,insure15,insured,insure5,sickadvice15,sickplace,didntgetcare15,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup ,bmi,child,sex) %>% 
  mutate(year = 2015) %>% 
  dplyr::rename(insuredgateway = insuredgateway15, insure = insure15,sickadvice = sickadvice15,didntgetcare = didntgetcare15)


chs14 = read_sas("data/chs2014_public.sas7bdat")

chs14_filter = chs14 %>% 
  dplyr::select(agegroup,generalhealth,insuredgateway14,insure14,insured,insure5,sickadvice14,sickplace,didntgetcare14,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup ,bmi,child,sex) %>% 
  mutate(year = 2014) %>% 
  dplyr::rename(insuredgateway = insuredgateway14, insure = insure14,sickadvice = sickadvice14,didntgetcare = didntgetcare14)


chs_14_16 = bind_rows(chs14_filter,chs15_filter,chs16_filter)
  
```


```{r}
dataset_basic = chs_14_16 %>% 
  select(agegroup,insure,smoker,everyday,numberperdaya,cost20cigarettes,generalhealth,imputed_povertygroup,bmi,child,sex,insuredgateway) %>% 
  mutate(numberperdaya = round(numberperdaya,1),
         imputed_povertygroup = factor(imputed_povertygroup),
         child = factor(child,levels = c(1,2)),
         sex = factor(sex),
         insure = factor(insure,levels = c(1,2,3,4,5,6,7)),
         generalhealth = factor(generalhealth,levels = c(5,4,3,2,1)),
         smoker = factor(smoker,levels = c(1,2,3)),
         everyday = factor(everyday),
         agegroup = factor(agegroup,ordered = TRUE),
         imputed_povertygroup = factor(imputed_povertygroup,levels = c(1,2,3,4,5))
         )
#write_csv(dataset_basic,"data/dataset_basic.csv")
```


For **Medical Cost Personal Dataset**, we mutate some continuous variables into factor variables

```{r, clean insurance cost data}
cost_df = read.csv("data/medical_cost_clean.csv") %>% 
  mutate(
    sex = as.factor(sex),
    smoker = as.factor(smoker),
    children_group = as.factor(children_group)
  )

```

**This dataset includes the following variables**

* `age`: Age
* `sex`: Sex (1 = male, 2 = female)
* `bmi`: Body Mass Index
* `children`: number of children the person has
* `smoker`: smoking status (0 = non-smoker, 1 = smoker)
* `region`: region in th US
* `charges`: Insurance charges
* `children_group`: whether or not the person has children (0 = No children, 1 = At least one child)


<br>


## Exploratory analysis
Visualizations, summaries, and exploratory statistical analyses. Justify the steps you took, and show any major changes to your ideas.

<br>


## Additional analysis

In order to assists our main research topic, the relationship between smoking and health insurance, we would like to investigate the amount of insurance price change due to smoking, along with other personal factors such age, sex, weight and whether or not having children. A **prediction model** is build to analyse this question.


### A snapshot of the vairables

We selected the following variable for modeling. Detailed information are in the table below:
```{r}
var <- c("smoker", "children_group", "sex", "age", "bmi", "charges")

var_meaning <- c("0 = non-smoker, 1 = smoker", "0 = No children, 1 = Have at least 1 child", "1 = male, 2 = female", "Age range from 18 to 63", "Body mass index range from 15.96 to 53.13", "Cost of health insurance")

var_info <- data.frame(var, var_meaning) %>% 
  dplyr::rename(
    "Variable name" = var,
    "Variable information" = var_meaning
  )
knitr::kable(var_info)
```


### Relationship between each variables and charge of insurance {.tabset}

#### Smoker and insurance charges

```{r}

cost_df_smoker = 
  cost_df %>%
  mutate(
    smoker = fct_recode(
      smoker,
      "Smoker" = "1",
      "Non smoker" = "0"
      ))
    
smoker_plotly <- cost_df_smoker %>% 
  plot_ly(
    x = ~smoker,
    y = ~charges,
    split = ~smoker,
    type = 'violin',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    )
  ) 

smoker_plotly <- smoker_plotly %>%
  layout(
    xaxis = list(
      title = "smokeing status"
    ),
    yaxis = list(
      title = "Insurance charges",
      zeroline = F
    ),
    legend=list(title=list(text='<b> Smokering Status </b>'))
  )

smoker_plotly
```

<br>

#### Having children and insurance charges

```{r}
cost_df_child = 
  cost_df %>%
  mutate(
    children_group = fct_recode(
      children_group,
      "Having at least one child" = "1",
      "No children" = "0"
      ))
    
child_plotly <- cost_df_child %>% 
  plot_ly(
    x = ~children_group,
    y = ~charges,
    split = ~children_group,
    type = 'violin',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    )
  ) 

child_plotly <- child_plotly %>%
  layout(
    xaxis = list(
      title = "Whether or not having children"
    ),
    yaxis = list(
      title = "Insurance charges",
      zeroline = F
    ),
    legend=list(title=list(text='<b> Whether or not having children </b>'))
  )

child_plotly
```


<br>

#### Gender and insurance charges

```{r}
cost_df_sex = 
  cost_df %>%
  mutate(
    sex = fct_recode(
      sex,
      "Male" = "1",
      "Female" = "2"
      ))
    
sex_plotly <- cost_df_sex %>% 
  plot_ly(
    x = ~sex,
    y = ~charges,
    split = ~sex,
    type = 'violin',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    )
  ) 

sex_plotly <- sex_plotly %>%
  layout(
    xaxis = list(
      title = "Gender"
    ),
    yaxis = list(
      title = "Insurance charges",
      zeroline = F
    ) ,
    legend=list(title=list(text='<b> Gender </b>'))
  )

sex_plotly
```

<br>

#### Age and insurance charges

```{r}
age_fit <- lm(charges ~ age, data = cost_df)


age_plotly <- plot_ly(
  cost_df, 
  x = ~age, 
  y = ~charges,
  color = ~age,
  size = ~age,
  name = ""
  ) %>% 
  add_markers(y = ~charges) %>% 
  add_lines(x = ~age, y = fitted(age_fit), color = "") %>% 
  layout(
   showlegend = FALSE
  )


age_plotly
```

<br>

#### BMI and insurance charges

```{r}
bmi_fit <- lm(charges ~ bmi, data = cost_df)


bmi_plotly <- plot_ly(
  cost_df, 
  x = ~bmi, 
  y = ~charges,
  color = ~bmi, 
  size = ~bmi,
  name = ""
  ) %>% 
  add_markers(y = ~charges) %>% 
  add_lines(x = ~bmi, y = fitted(bmi_fit), color = "") %>% 
  layout(showlegend = FALSE)


bmi_plotly
```

<br>

###

From the five plots above, we can tell that smoking, age, and bmi significantly affect charge of insurance. The relationship between charges and gender or having children is unclear. Further analysis will be carried below to illustrate their relationships.



### Model selection

#### Correlation plot

```{r}

cost_df_cor = cost_df %>% 
  dplyr::select(age, sex, bmi, smoker, charges, children_group)

model.matrix(~0+., data = cost_df_cor) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=2)

```

There is no collinearity between any of the variables. Therefore, no need to adjust variable for model building. In addition, smoking seems to be the highest correlated variable to charges among other variables.



**Fit regression using all predictors**

```{r}
model <- lm(charges ~ smoker + children_group + sex + age + bmi, data = cost_df)
summary(model)%>% 
  broom::tidy() %>% 
  knitr::kable()
```

The model building result shows that sex is not a significant variable with p-value < 0.05. Therefore, when we do the stepwise regression, we would likely to remove the variable of sex.


#### Stepwise regression

```{r, results="hide"}
step = step(model, direction='both')
```

```{r}
summary(step)%>% 
  broom::tidy() %>% 
  knitr::kable()

```

The stepwise regression process confirms that sex is not significant variable. Therefore we remove sex variable and retain all other variables for prediction model.

#### Final model with significant variables

```{r}
model1 <- lm(charges ~ smoker + children_group + age + bmi, data = cost_df)
summary(model1) %>% 
  broom::tidy() %>% 
  knitr::kable()
```



### Model diagnostic
```{r, fig.width = 7, fig.height = 5}
par(mfrow = c(2,2))
plot(model1)
```

The graph above did not show homoscedasticity of residual. Therefore, we need to transform the model.



### Model transformation

#### Box-Cox Transformation

```{r, fig.width = 7, fig.height = 3.5}

par(mfrow = c(1,2))

boxcox(model1, lambda = seq(-3, 3, by = 0.25)) 

plot(model1, which = 4) # remove 544, 578, 1301

```

```{r}

cost_df_out = cost_df[-c(544,578, 1301),]

```


Since lamda = 0, try natural log transformation.

**Before transformation, remove outliers first**

The outliers are rows 544, 578, 1301. Following model building will use dataset without these outliers.





**Transform charges to ln(charges)**

```{r}

#summary(cost_df_out)
cost_df_log = cost_df_out %>% 
  mutate(
    Lncharges = log(charges)
  ) 

# fit multivariate model with log transform
model_log = lm(Lncharges ~ smoker + children_group + age + bmi, data = cost_df_log) 
summary(model_log) %>% 
  broom::tidy() %>% 
  knitr::kable()

```

Above table shows the estimates for each variables when charges is transformed to In(charges).



#### Diagnostic for transformed model



```{r, fig.width = 5, fig.height = 3}

boxcox(model_log)
```

```{r, fig.width = 7, fig.height = 5}
par(mfrow = c(2,2))
plot(model_log)
```

Lamda is near 1 now, and the residual distribution improved from un-transformed data. We conclude this model is acceptable.

<br>



### Final model

```{r}
summary(model_log) %>% 
  broom::tidy() %>% 
  knitr::kable()
```



#### Decode the model estimates

Holding all other variable fixed, smoking is associated with a 155% increase in insurance charges than non-smokers. Being older, higher body mass index, and having at least 1 children also increase insurance charges.

### Shiny dashboard for predicting insurance charge

The [Shiny dashboard](https://yiqunjin.shinyapps.io/shiny_dashboard/) is a visualization of the prediction of insurance premium. By providing the information of age, BMI, smoke or not smoke, with or without children, user could get a general idea of the range of insurance premium.

<br>


## Additional visualization {.tabset}

In order to provide reader who are seeking help for signing up insurance and getting advice about health insurance, we provide several maps of health insurance related agencies with location and contact information. Click on the icons on the maps for detailed information.

### Health center location mapping

For general public seeking assistance with signing up for health insurance or SNAP (Supplemental Nutrition Assistance Program), here is a mapping of health center locations, where health insurance enrollment and assistance with SNAP benefits (Food Stamps) are offered.

```{r, echo = FALSE}
health_center = read.csv("data/health_center.csv") %>% 
  janitor::clean_names() 
```

```{r leaflet mapping}
leaflet(health_center) %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
  addMarkers(lat = ~latitude, 
             lng = ~longitude, 
             popup = paste("Health Center name:", health_center$health_center, "<br>", "Street address:", health_center$street_address, "<br>", "Telephone number:", health_center$telephone_number, "<br>", "Borough:", health_center$borough),
             clusterOptions = markerClusterOptions())
```

<br>

**Time of operation and walk-in:**
```{r}
health_center_table = health_center %>% 
  dplyr::select(health_center, street_address, telephone_number, days_of_operation, hours_of_operation, accept_walk_ins) %>% 
  mutate(
    accept_walk_ins = c(rep("Yes",11))
  ) %>% 
  relocate(
    health_center, days_of_operation, hours_of_operation, accept_walk_ins,
    street_address, telephone_number
    ) %>% 
  dplyr::rename(
    "Health Center name" = health_center,
    "Street address" = street_address,
    "Telephone number" = telephone_number,
    "Days of operation" = days_of_operation,
    "Hours of operation" = hours_of_operation,
    "Accept walk in" = accept_walk_ins
  )
  
rmarkdown::paged_table(health_center_table)
```

<br>

### Insurance agency location mapping

For those who are interested in purchasing insurance, this map shows the locations of major health insurance carriers in NYC.

<img src="images/insurance_agency.jpeg" style="width:70%">

```{r, echo = FALSE}
insurance_agency = read.csv("data/insurance_agency.csv") %>% 
  na.omit() %>% 
  janitor::clean_names() 
```

```{r}
leaflet(insurance_agency) %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
  addMarkers(lat = ~latitude, 
             lng = ~longitude, 
             popup = paste("Insurance agency name:", insurance_agency$insurance_agency, "<br>", "Street address:", insurance_agency$street_address, "<br>", "Telephone number:", insurance_agency$telephone_number, "<br>", "Borough:", insurance_agency$borough),
             clusterOptions = markerClusterOptions())
```

<br>

**Time of operation and walk-in:**
```{r}
insurance_agency_table =insurance_agency %>% 
  dplyr::select(insurance_agency, street_address, telephone_number, days_of_operation, hours_of_operation, accept_walk_ins) %>% 
  
  relocate(
    insurance_agency, days_of_operation, hours_of_operation, accept_walk_ins,
    street_address, telephone_number
    ) %>% 
  dplyr::rename(
    "Insurance agency name" = insurance_agency,
    "Street address" = street_address,
    "Telephone number" = telephone_number,
    "Days of operation" = days_of_operation,
    "Hours of operation" = hours_of_operation,
    "Accept walk in" = accept_walk_ins
  )
  
rmarkdown::paged_table(insurance_agency_table)
```

<br>

### Medicaid location mapping

Medicaid provides health coverage to low-income people, including eligible low-income adults, children, pregnant women, elderly adults and people with disabilities. Medicaid is one of the largest payers for health care in the United States and is administered by states, according to federal requirements. The program is funded jointly by states and the federal government.

```{r, echo = FALSE, message = FALSE}
medicaid_provider = GET("https://health.data.ny.gov/resource/keti-qx5t.csv",
                        query = list("$limit" = 10000)) %>% 
  content("parsed")

medicaid = medicaid_provider %>% 
  janitor::clean_names() %>% 
  #drop_na() %>% 
  filter(state == "NY") %>% 
  filter(city %in% c("NEW YORK", "FLUSHING", "BRONX", "BROOKLYN", "STATEN ISLAND")) %>% 
  filter(county %in%  c("NEW YORK", "QUEENS", "BRONX", "BROOKLYN", "STATEN ISLAND")) %>% 
  subset(!(telephone %in% c(3155365160, 8458875530, 2129871777, 2128971994,2127723111)))

```


```{r, echo = FALSE, warning=FALSE}
leaflet(medicaid) %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
  addMarkers(lat = ~latitude, 
             lng = ~longitude, 
             popup = paste("Provider name:", medicaid$mmis_name, "<br>", "Street address:", medicaid$service_address, "<br>", "Telephone number:", medicaid$telephone),
             clusterOptions = markerClusterOptions())
```

<br>


## Discussion
* Smoker insurance preferences: If smokers tend to get insurance and what type of insurance they prefer;
* Insurance charges prediction: personal factors that affect insurance cost. 

The uninsured rate for current smokers is 44.4% higher than people who currently do not smoke.

For person younger than 65 years old, people tend to get insurance as age increase. Specifically, for those age in the range of 25-64 years old, high proportion of them get employer insurance since they are in working age.
For person older than 65 years old, most of them get Medicare since Medicare is only provided for people above 65 years old.

During the prediction model building process, we found that when holding all other variable fixed, smoking is associated with a 155% increase in insurance charges than non-smokers. This finding confirmed the fact that smokers are charged for higher insurance. In addition, being older, higher body mass index, and having at least 1 children also increase insurance costs. 

For future analysis of relationship between smoking and health insurance, we would like to stratify states in the U.S. in order to eliminate the bias caused by policies, economy, and social behavior.

<br>


## Citation

Department of Health and Mental Hygiene. (2018, June 20). Primary care access and planning - health insurance enrollment: NYC Open Data. Primary Care Access and Planning - Health Insurance Enrollment | NYC Open Data. Retrieved December 5, 2021, from https://data.cityofnewyork.us/Health/Primary-Care-Access-and-Planning-Health-Insurance-/gfej-by6h. 

Health Insurance Companies - eHealth. (n.d.). Retrieved December 5, 2021, from https://www.ehealthinsurance.com/health-insurance-companies. 

What you need to know about smoking and health insurance. HealthMarkets. (n.d.). Retrieved December 5, 2021, from https://www.healthmarkets.com/content/smoking-and-health-insurance. 

What's Medicare? Medicare. (n.d.). Retrieved December 5, 2021, from https://www.medicare.gov/what-medicare-covers/your-medicare-coverage-choices/whats-medicare. 

Members. Medical Mutual. (n.d.). Retrieved December 5, 2021, from https://www.medmutual.com/for-individuals-and-families/health-insurance-education/health-insurance-basics/employer-vs-individual-health-insurance.aspx. 

Wikimedia Foundation. (2021, August 14). Consolidated omnibus budget reconciliation act of 1985. Wikipedia. Retrieved December 5, 2021, from https://en.wikipedia.org/wiki/Consolidated_Omnibus_Budget_Reconciliation_Act_of_1985. 




