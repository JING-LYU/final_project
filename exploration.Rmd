---
title: "data exploration"
output: 
  html_document:
    code_folding: hide
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(haven)
library(summarytools)
library(ggstatsplot)
library(ggplot2)

```

```{r message=FALSE}
dataset_basic = read_csv("data/dataset_basic.csv") %>% 
  mutate(
         child = factor(child,levels = c(1,2),labels = c("yes","no")),
         sex = factor(sex,labels = c("male","female")),
         insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured")),
         smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         agegroup = factor(agegroup,ordered = TRUE,labels = c("18-24yrs","25-44yrs", "45-64yrs", "65+yrs"))
         ) %>% 
  select(insure,agegroup,smoker,bmi,child,sex)
```


### Variables and insurance {.tabset}

#### Smoking

##### Plot

```{r message=FALSE}
analyse_smoke_insurancetype = 
  dataset_basic %>%
  drop_na(smoker,insure) %>% 
  group_by(smoker,insure) %>% 
  summarize(n = n())
  
analyse_smoke_insurancetype %>% 
  ggplot(aes(x =smoker , y = n, fill = insure)) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'smoking group ',
      y = 'counts',
      title = 'The distribution of insurance in different smoking group ')
```

##### Chi-quare test between insurance type and smoking

$H_0$ : insurance type and smoking are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and smoking are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
#test_data_smoke_insurancetype = analyse_smoke_insurancetype %>% 
#  pivot_wider(
#  names_from = "insure", 
#  values_from = "n")

#test_data_smoke_insurancetype %>% knitr::kable()
#chisq.test(test_data_smoke_insurancetype[-1])

dat = 
  dataset_basic %>%
  drop_na(smoker,insure) 

dat %$%
  ctable(smoker, insure,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )


# plot
ggbarstats(
  data = dat,
  x = smoker,
  y = insure
) +
  labs(caption = NULL) # remove caption


```



#### Age
##### Plot

```{r message=FALSE}
analyse_agegroup_insurancetype = 
  dataset_basic %>%
  drop_na(agegroup,insure) %>% 
  group_by(insure,agegroup) %>% 
  summarize(n = n())
  
analyse_agegroup_insurancetype %>% 
  ggplot(aes(x = agegroup, y = n, fill = insure  )) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'agegroup',
      y = 'counts',
      title = 'The distribution of insurance type in differnt agegroup')
```

##### Chi-quare test  between insurance type and age

$H_0$ : insurance type and age are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and age are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
#test_data_smoke_insurancetype = analyse_smoke_insurancetype %>% 
#  pivot_wider(
#  names_from = "insure", 
#  values_from = "n")

#test_data_smoke_insurancetype %>% knitr::kable()
#chisq.test(test_data_smoke_insurancetype[-1])

dat = 
  dataset_basic %>%
  drop_na(agegroup,insure) 

dat %$%
  ctable(agegroup, insure,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )


ggbarstats(
  data = dat,
  x = smoker,
  y = insure
) +
  labs(caption = NULL) # remove caption

```

#### Have children or not
##### Plot
```{r message=FALSE}
analyse_children_insurancetype = 
  dataset_basic %>%
  drop_na(child,insure)  %>% 
  group_by(insure,child) %>% 
  summarize(n = n())
  
analyse_children_insurancetype %>% 
  ggplot(aes(x = child, y = n, fill = insure )) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'child',
      y = 'counts',
      title = 'The distribution of insurance type in groups of people with or without children')
```


##### Chi-quare test  between insurance type and children

$H_0$ : insurance type and have children or not are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and have children or not are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
#test_data_smoke_insurancetype = analyse_smoke_insurancetype %>% 
#  pivot_wider(
#  names_from = "insure", 
#  values_from = "n")

#test_data_smoke_insurancetype %>% knitr::kable()
#chisq.test(test_data_smoke_insurancetype[-1])

dat = 
  dataset_basic %>%
  drop_na(child,insure)

# fourth method:
dat %$%
  ctable(child, insure,
    prop = "r", chisq = TRUE, headings = FALSE
  ) %>%
  print(
    method = "render",
    style = "rmarkdown",
    footnote = NA
  )

ggbarstats(
  data = dat,
  x = child,
  y = insure
) +
  labs(caption = NULL) # remove caption

```

#### BMI
##### Plot

```{r message=FALSE}
analyse_bmi_insurancetype = 
  dataset_basic %>%
  drop_na(bmi,insure) 
  
  
  
analyse_bmi_insurancetype %>% 
  ggplot(aes(x = insure, y = bmi,fill = insure)) + 
  geom_boxplot(alpha = 0.3) +
    theme(legend.position = "none") +
    scale_fill_brewer(palette = "BuPu") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'insurance',
      y = 'bmi',
      title = 'The distribution of bmi in groups having different insurance type')
```

##### ANOVA test  between insurance type and BMI

*Test result:*
```{r}
anova = aov( bmi ~insure, data = analyse_bmi_insurancetype)
summary(anova)
Tukey_comp = TukeyHSD(anova)
Tukey_comp 
  
plot(Tukey_comp)
```

