---
title: "Data exploration"
output: 
  html_document:
    code_folding: hide
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(haven)
library(summarytools)
library(ggstatsplot)
library(ggplot2)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r message=FALSE}
ataset_basic = read_csv("data/dataset_basic.csv")

dataset_basic = read_csv("data/dataset_basic.csv") %>% 
  mutate(
         child = factor(child,levels = c(1,2),labels = c("yes","no")),
         sex = factor(sex,labels = c("male","female")),
         insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured")),
         smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         agegroup = factor(agegroup,ordered = TRUE,labels = c("18-24yrs","25-44yrs", "45-64yrs", "65+yrs"))
         ) %>% 
  select(insure,agegroup,smoker,bmi,child,sex)
```


```{r message=FALSE}

smoke_df = read_csv("data/dataset_basic.csv") %>% 
  select(agegroup,smoker,everyday,numberperdaya,cost20cigarettes,generalhealth,poverty_group = imputed_povertygroup,bmi,child,sex) %>% 
  drop_na(smoker) %>% 
  mutate(
         smoker_cat = case_when(
           numberperdaya <= 10 ~ 1,
           (numberperdaya > 10) & (numberperdaya <= 20) ~2,
           numberperdaya > 20 ~ 3),
         smoker_cat = factor(smoker_cat,levels = c(1,2,3),labels = c("light","normal","heavy")),
         smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         agegroup = factor(agegroup,ordered = TRUE,labels = c("18-24yrs","25-44yrs", "45-64yrs", "65+yrs")),
         generalhealth = factor(generalhealth,levels = c(5,4,3,2,1), labels = c("Poor","Fair","Good","Very good","Excellent")),
         poverty_group = factor(poverty_group,levels = c(1,2,3,4,5),labels = c("<100% FPL","100 - <200% FPL","200 - <400% FPL","400 - <600% FPL",">600% FPL")),
         everyday = factor(everyday, levels = c(1,2), labels = c("everyday smoker", "casual smoker"))
         
         )

current_smoker = smoke_df %>% filter(smoker == "current")
```


## 1. Knowledge about **insurance** in our dataset

- Among 2941 participants in the dataset: 2582 (88%) of them are insurance holders, while 359 (12%) of them don't have insurance cover. 

- Most of participants have employer-sponsored health insurance (38%), other types include Medicaid/Family Health+ (24%), Medicare (20%), Uninsured (9%), Self-purchase (6%), COBRA/Other (2%) and Milit/CHAMPUS/Tricare (1%). 

- Detailed introduction on each insurance type is summarized in the below table:

```{r message=FALSE}
insurehold = read_csv("data/dataset_basic.csv") %>% 
  drop_na() %>% 
  mutate(
  insuredgateway = factor(insuredgateway, levels = c(1,2), labels = c("yes", "no"))) %>% 
  ggplot(aes(x = insuredgateway,fill = insuredgateway))+
  geom_bar()+
  theme(legend.position = "none") +
  labs(
    x = "Hold status of insurance",
    y = "Number of participants",
    title = "Holding status of insurace among participants")
  
```


```{r }
insuretype = dataset_basic %>% 
  drop_na() %>% 
  mutate(insure = fct_infreq(insure)) %>% 
  ggplot(aes(x = insure,fill = insure))+
  geom_bar()+
  theme(legend.position = "none") +
  labs(
    x = "Insurance type",
    y = "Number of holders",
    title = "Number of holders in each insurance type") + 
  coord_flip()
  
  
```

```{r}
#| my-chunkhaha, echo = FALSE, fig.width = 10,
insurehold + insuretype
```


```{r}
insur_type <- c("Employer", "Medicare", "Milit/CHAMPUS", "Uninsured", "Self-purchased", "Medicaid/Family Health+", "COBRA/other")

insur_meaning <- c("Employer-sponsored health insurance is a health insurance selected and purchased by your employer and offered to eligible employees and their dependents.",
                   "Medicare is federal health insurance for people 65 or older, some younger people with disabilities, people with End-Stage Renal Disease",
                   "Health Care progam for military",
                   "Not insured",
                   "Insurance purchased by individual choice",
                   "Medicaid/health insurance program for adults who are aged 19 to 64 who have income too high to qualify for Medicaid",
                   "Consolidated Omnibus Budget Reconciliation Act, which gives some employees the ability to continue health insurance coverage after leaving employment, or other types of insurance.")

insur <- data.frame(insur_type, insur_meaning) %>% 
  dplyr::rename(
    "Insurance type" = insur_type,
    "Insurance type meaning" = insur_meaning
  )
knitr::kable(insur)
```

<br>

### 2. Knowledge regarding **smoking** in our dataset

Here we conduct some explorations focusing on smoking information in our data. Click on each tab to see different dimensions of smoking data.

#### Smoking status {.tabset}

##### Age distribution


```{r,message=FALSE}

smoke_df %>% 
  drop_na(agegroup) %>% 
  group_by(agegroup,smoker) %>% 
  dplyr::summarize(
    count = n()
  ) %>% 
  mutate(smoker = fct_reorder(smoker,count)) %>% 
  ggplot(aes(x = smoker, y = count, fill = agegroup)) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'Smoking status',
      y = 'Number of smokers',
      title = 'Age distribution among people in different smoking status')


```

There are a total 3652 (12%) current smokers, 6167 (21%) former smokers, and 18693 (66%) people never smoked among all the participants.  Most current smokers falls in age 25 to 64 (80%). 84% of the paticipants in age 18-24 filter have never smoked.

##### Health self-evaluation



```{r,message=FALSE}


smokegroup_count = smoke_df %>% 
  drop_na(smoker) %>% 
  dplyr::group_by(smoker) %>% 
  dplyr::summarize(
    smokegroup_count = n()) %>% 
  pull()

smoke_df %>% 
  drop_na(generalhealth) %>% 
  dplyr::group_by(generalhealth,smoker) %>% 
  dplyr::summarize(
    count = n())%>% 
  mutate(smokegroup_count = smokegroup_count,
         health_percent = count/smokegroup_count)%>% 
  ggplot(aes(x = smoker, y = health_percent, fill = generalhealth)) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'Smoking status',
      y = 'Health self-evaluation \n(% in each types of smoker)',
      title = 'Self-evaluation of health conditions among people in different smoking status\n(% in each types of smoker)')
```

No matter whether smoked, participants' self-evaluation on the health condition follows similar distribution. Smoking may not be a key factor when people self-evaluate their health condition.

##### Poverty status

```{r,message=FALSE}
smoke_df %>% 
  drop_na(poverty_group) %>% 
  group_by(poverty_group,smoker) %>% 
  dplyr::summarize(
    count = n()
  ) %>% 
  mutate(
    smokegroup_count = smokegroup_count,
    poverty_percent = count/smokegroup_count,
    smoker = fct_reorder(smoker,count)) %>% 
  ggplot(aes(x = smoker, y = poverty_percent, fill = poverty_group)) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'Smoking status',
      y = 'Poverty groups',
      title = 'Poverty groups among people in different smoking status')
```

For people who are current smokers and who has never smoked, number of people in each poverty group decreace with higher poverty level. However, among former smokers, number of people in different levels of poverty groups are close in quantities.

#### Current smokers {.tabset}

For `never` and `former` smokers, no data for variables `everyday`, `numberperdaya`, `cost20cigarettes`, so next we **focus on the current smokers**.

##### Daily consumption

```{r message=FALSE, warning=FALSE}
type = current_smoker %>%
  ggplot(aes(x = smoker_cat, fill = everyday))+
  geom_histogram(stat="count") +
    labs(
      x = 'Type of current smokers',
      y = 'Number of smokers in each type',
      title = 'Number of current smokers\nof diffirent types')+
  theme(legend.position = "none")
```


```{r message=FALSE, warning=FALSE}
consumption = current_smoker %>% 
  ggplot(aes(x = numberperdaya, fill = everyday)) + 
  geom_histogram()+
  xlim(0,30)+
  labs(
    x = "Average number of cigarattes smoked per day",
    y = "Number of smokers",
    title = "Average number of cigarattes\nsmoked per day",
    fill = "Smoking frequency"
       )+
  theme(legend.position = "right")
```

```{r message=FALSE, warning=FALSE}
#| my-chunkn, echo = FALSE, fig.width = 8,
type + consumption
```

Most of the current smokers are light smokers. Among those light smokers, nearly half of them smoke everyday, while normal and heavy smokers are more likely to smoke everyday. Casual smokers tend to consume less cigarette than everyday smokers.

##### Cost on smoke

```{r message=FALSE, warning=FALSE}
  
current_smoker %>% 
  ggplot(aes(x = numberperdaya, y = cost20cigarettes,color = everyday))+
  geom_point(alpha = .5,size = 3) +
  xlim(0,50)+
  ylim(0,40)+
  theme(plot.title = element_text(hjust = 0.5)) +
  #facet_grid(.~smoker_cat,scales = "free") +
    labs(
      x = 'Number of cigrattes consumed everyday',
      y = 'Cost of every 20 (one pack) cigrattes',
      title = 'Cost of every 20 (one pack) cigrattes\nfor number of cigrattes consumed everyday',
      color = "Smoking frequency")


```

Regardless of smoking frequency and smoking intensity, the cost of each pack of cigarette are even distributed within \$0 to \$20

<br>



## 3. Explore relationship between `insurance` and target variables
In this step, we want to explore more about the relationship between insurance and key variables, including smoking, age, have children or not and BMI. We start by plotting distribution graphs to see the pattern between each groups. And then we conduct statistical tests to evaluate the association and similarity between them.

<br>

### Distributions {.tabset}
#### Smoking


```{r message=FALSE}
analyse_smoke_insurancetype = 
  dataset_basic %>%
  drop_na(smoker,insure) %>% 
  group_by(smoker,insure) %>% 
  summarize(n = n()) %>% 
  mutate(insure = fct_reorder(insure,n))
  
analyse_smoke_insurancetype %>% 
  ggplot(aes(x =smoker , y = n, fill = insure)) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'smoking group ',
      y = 'counts',
      title = 'The distribution of insurance in different smoking group ')
```

#### Age


```{r message=FALSE}
analyse_agegroup_insurancetype = 
  dataset_basic %>%
  drop_na(agegroup,insure) %>% 
  group_by(agegroup,insure) %>% 
  summarize(n = n()) %>% 
  mutate(insure = fct_reorder(insure,n))
  
analyse_agegroup_insurancetype %>% 
  ggplot(aes(x = agegroup, y = n, fill = insure  )) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'agegroup',
      y = 'counts',
      title = 'The distribution of insurance type in differnt agegroup')
```
For person younger than 65 years old, people tend to get insurance as age increase. Specifically, for those age in the range of 25-64 years old, high proportion of them get **employer** insurance since they are in working age.

For person older than 65 years old, most of them get **Medicare** since Medicare is only provided for people above 65 years old.

#### Have children or not


```{r message=FALSE}
analyse_children_insurancetype = 
  dataset_basic %>%
  drop_na(child,insure)  %>% 
  group_by(child,insure) %>% 
  summarize(n = n())%>% 
  mutate(insure = fct_reorder(insure,n))
  
analyse_children_insurancetype %>% 
  ggplot(aes(x = child, y = n, fill = insure )) + 
  geom_bar(stat = "identity",position = "dodge") +
    labs(
      x = 'child',
      y = 'counts',
      title = 'The distribution of insurance type in groups of people with or without children')
```

We found that for those without children, a larger proportion of them get **Medicare** comparing to those with children.

#### BMI


```{r message=FALSE}
analyse_bmi_insurancetype = 
  dataset_basic %>%
  drop_na(bmi,insure) 
  
  
  
analyse_bmi_insurancetype %>% 
  ggplot(aes(x = insure, y = bmi,fill = insure)) + 
  geom_boxplot(alpha=0.6) +
    theme(legend.position="none") +
    scale_fill_brewer(palette="Dark2")+
    labs(
      x = 'insurance',
      y = 'bmi',
      title = 'The distribution of bmi in groups having different insurance type') +
  coord_flip()
```

We did not observe significant difference between each group.


<br>

### Statistical test {.tabset}

#### Smoking

##### **Chi-quare test between insurance type and smoking**

$H_0$ : insurance type and smoking are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and smoking are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
dat = 
  dataset_basic %>%
  drop_na(smoker,insure) 
```

```{r}
#| my-chunk1, echo = FALSE, fig.width = 10,

# plot
ggbarstats(
  data = dat,
  x = smoker,
  y = insure,
  title = "Chi-quare test between insurance type and smoking"
) +
  labs(caption = NULL) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) 


```

We reject $H_0$ and then conclude that insurance type and smoking are dependent.



#### Age
##### **Chi-quare test  between insurance type and age**

$H_0$ : insurance type and age are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and age are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
dat = 
  dataset_basic %>%
  drop_na(agegroup,insure) 
```

```{r}
#| my-chunk2, echo = FALSE, fig.width = 10,
ggbarstats(
  data = dat,
  x = smoker,
  y = insure,
  title = "Chi-quare test result between insurance type and age"
) +
  labs(caption = NULL) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) 

```

We reject $H_0$ and then conclude that insurance type and age are dependent.

#### Have children or not
##### **Chi-quare test  between insurance type and children**

$H_0$ : insurance type and have children or not are independent, there is no relationship between the two categorical variables. 

$H_1$ : insurance type and have children or not are dependent, there is a relationship between the two categorical variables. 

*Test result:*

```{r}
#test_data_smoke_insurancetype = analyse_smoke_insurancetype %>% 
#  pivot_wider(
#  names_from = "insure", 
#  values_from = "n")

#test_data_smoke_insurancetype %>% knitr::kable()
#chisq.test(test_data_smoke_insurancetype[-1])

dat = 
  dataset_basic %>%
  drop_na(child,insure)
```

```{r}
#| my-chunk3, echo = FALSE, fig.width = 10,

ggbarstats(
  data = dat,
  x = child,
  y = insure,
  title = "Chi-quare test between insurance type and children"
) +
  labs(caption = NULL) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) 
```

We reject $H_0$ and then conclude that insurance type and children are dependent.

#### BMI
##### **ANOVA test  between insurance type and BMI**
$H_0$ : The mean of BMI in each insurance type groups are the same

$H_1$ : At least two means of BMI in all insurance type groups are different

*Test result:*
```{r}
#| my-chunk6, echo = FALSE, fig.width = 10,fig.height = 10
anova = aov( bmi ~insure, data = analyse_bmi_insurancetype)
anova %>% 
  broom::tidy() %>% 
  knitr::kable()
Tukey_comp = TukeyHSD(anova)

par(mar = c(2, 18, 2, 2))
plot(Tukey_comp,las = 1,
     cex.axis = 0.8)
```

According to the ANOVA test, we reject $H_0$  and conclude At least two means of BMI in all insurance type groups are different. Detailed information of the difference in each group can be seen on the above image. 

<br>


