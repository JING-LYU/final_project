---
title: "Data Exploaration"
author: "LYU JING"
date: "11/21/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(haven)
library(patchwork)
```


### Sample code given with the source data

```{}
rm(list=ls(all=TRUE))
library("haven")
library("survey")
library(dplyr)
require(data.table)
chs17<-read_sas("data/chs2017_public.sas7bdat")

#city-wide estimates
chs<-transform(chs17,strata=as.character(strata),all=as.factor(survey))

#define the survey
chs.dsgn<-svydesign(ids = ~1,strata = ~strata,weights=~wt18_dual,data = chs,nest = TRUE,na.rm=TRUE )
#age adjusted survey
pop.agecat4=c(0.128810, 0.401725, 0.299194, 0.170271)
chs.stdes<-svystandardize(subset(chs.dsgn,diabetes17>0 ),by=~agegroup,over=~all,population=pop.agecat4,excluding.missing =~ agegroup+ ~all)

#weighted N
aggregate(chs17$wt18_dual, by=list(Category=chs17$diabetes17), FUN=sum)

#crude prevalance estimates
svyby(~diabetes17==1,~all,subset(chs.dsgn,diabetes17>0),svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))
svyby(~diabetes17==2,~all,subset(chs.dsgn,diabetes17>0),svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))

#age adjusted prevalance estimates

svyby(~diabetes17==1,~all,chs.stdes,svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))
svyby(~diabetes17==2,~all,chs.stdes,svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))

#estimate by sex
chs<-transform(chs17,strata=as.character(strata),allsex2=as.factor(sex))

#define the survey
chs.dsgn<-svydesign(ids = ~1,strata = ~strata,weights=~wt18_dual,data = chs,nest = TRUE,na.rm=TRUE )
#age adjusted survey
pop.agecat4=c(0.128810, 0.401725, 0.299194, 0.170271)
chs.stdes<-svystandardize(subset(chs.dsgn,diabetes17>0 ),by=~agegroup,over=~allsex2,population=pop.agecat4,excluding.missing =~ agegroup+ ~allsex2)

#crude prevalance estimates
svyby(~diabetes17==1,~allsex2,subset(chs.dsgn,diabetes17>0),svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))
svyby(~diabetes17==2,~allsex2,subset(chs.dsgn,diabetes17>0),svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))


#age adjusted prevalance estimates

svyby(~diabetes17==1,~allsex2,chs.stdes,svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))
svyby(~diabetes17==2,~allsex2,chs.stdes,svyciprop,vartype = "ci",method="xlogit",df=degf(chs.dsgn))
```

## Data loading and crude cleaning

We select year 2014-2016 and variables relating to smoking and insurance. 

```{r}

chs16 = read_sas("data/chs2016_public.sas7bdat")

chs16_filter = chs16 %>% 
  select(agegroup,generalhealth,insuredgateway16,insure16,insured,insure5,sickadvice16,sickplace,didntgetcare16,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup,fluvaccineshot) %>% 
  mutate(year = 2016) %>% 
  rename(insuredgateway = insuredgateway16, insure = insure16,sickadvice = sickadvice16,didntgetcare = didntgetcare16)


chs15 = read_sas("data/chs2015_public.sas7bdat")

chs15_filter = chs15 %>% 
  select(agegroup,generalhealth,insuredgateway15,insure15,insured,insure5,sickadvice15,sickplace,didntgetcare15,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup,fluvaccineshot) %>% 
  mutate(year = 2015) %>% 
  rename(insuredgateway = insuredgateway15, insure = insure15,sickadvice = sickadvice15,didntgetcare = didntgetcare15)


chs14 = read_sas("data/chs2014_public.sas7bdat")

chs14_filter = chs14 %>% 
  select(agegroup,generalhealth,insuredgateway14,insure14,insured,insure5,sickadvice14,sickplace,didntgetcare14,smoker,everyday,numberperdaya,cost20cigarettes,imputed_povertygroup,fluvaccineshot) %>% 
  mutate(year = 2014) %>% 
  rename(insuredgateway = insuredgateway14, insure = insure14,sickadvice = sickadvice14,didntgetcare = didntgetcare14)


chs_14_16 = bind_rows(chs14_filter,chs15_filter,chs16_filter)
  





```


```{r}
dataset_basic = chs_14_16 %>% 
  select(agegroup,insuredgateway,insure,sickadvice,sickadvice,didntgetcare,smoker,everyday,numberperdaya,cost20cigarettes,generalhealth,fluvaccineshot,imputed_povertygroup) %>% 
  mutate(numberperdaya = round(numberperdaya,1))
```


```{r}
insurance_data = dataset_basic %>% 
  select(insuredgateway,insure,sickadvice,didntgetcare)


plot1 = insurance_data %>% 
  ggplot(aes(x = insuredgateway)) +
  geom_histogram() 
 
plot2 =insurance_data %>% 
  ggplot(aes(x = insure)) +
  geom_histogram()  

plot3 =insurance_data %>% 
  ggplot(aes(x = sickadvice)) +
  geom_histogram() 

plot4 =insurance_data %>% 
  ggplot(aes(x = didntgetcare)) +
  geom_histogram() 

plot1 + plot2 + plot3 + plot4
```


# relation between smoke and insurance type


```{r}
analyse_smoke_insurancetype = 
  dataset_basic %>%
  drop_na(smoker,insure) %>% 
  mutate(smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         everyday = factor(everyday)) %>% 
  mutate(insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured"))) %>% 
  group_by(smoker,insure) %>% 
  summarize(n = n())
  
analyse_smoke_insurancetype %>% 
  ggplot(aes(x = insure, y = n, fill = smoker)) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'insure type',
      y = 'counts',
      title = 'The distribution of insure in different smoking group ')

```



```{r}
test_data_smoke_insurance = analyse_smoke_insurancetype %>% 
  pivot_wider(
  names_from = "insure", 
  values_from = "n")
```

```{r}
test = chisq.test(test_data_smoke_insurance[-1])

```
smoke is significantly associated with insurance type

# relation between general health status and insurance type


```{r}
analyse_smoke_insurancetype = 
  dataset_basic %>%
  drop_na(smoker,insure) %>% 
  mutate(smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         everyday = factor(everyday)) %>% 
  mutate(insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured"))) %>% 
  group_by(smoker,insure) %>% 
  summarize(n = n())
  
analyse_smoke_insurancetype %>% 
  ggplot(aes(x = insure, y = n, fill = smoker)) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'insure type',
      y = 'counts',
      title = 'The distribution of insure in different smoking group ')

```




### try {.tabset}

#### insure

```{r}
analyse_smoke_insurancetype = 
  dataset_basic %>%
  drop_na(smoker,insure) %>% 
  mutate(smoker = factor(smoker,levels = c(1,2,3),labels = c("never","current","former")),
         everyday = factor(everyday)) %>% 
  mutate(insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured"))) %>% 
  group_by(smoker,insure) %>% 
  summarize(n = n())
  
analyse_smoke_insurancetype %>% 
  ggplot(aes(x = insure, y = n, fill = smoker)) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'insure type',
      y = 'counts',
      title = 'The distribution of insure in different smoking group ')
```

```{r}
test_data_smoke_insurancetype = analyse_smoke_insurancetype %>% 
  pivot_wider(
  names_from = "insure", 
  values_from = "n")
```

```{r}
chisq.test(test_data_smoke_insurancetype[-1])

```

#### healthstatus

```{r}
analyse_generalhealth_insurancetype = 
  dataset_basic %>%
  drop_na(generalhealth,insure) %>% 
  mutate(insure = factor(insure,levels = c(1,2,3,4,5,6,7),labels = c("Employer","Self-purchase","Medicare", "Medicaid/Family Health+", "Milit/CHAMPUS/Tricare", "COBRA/Other", "Uninsured")))%>% 
  mutate(generalhealth = factor(generalhealth,levels = c(1,2,3,4,5),labels = c("Excellent","Very good","Good", "Fair", "Poor"))) %>% 
  group_by(insure,generalhealth) %>% 
  summarize(n = n())
  
analyse_generalhealth_insurancetype %>% 
  ggplot(aes(x = insure, y = n, fill = generalhealth )) + 
  geom_bar(stat = "identity",position = "dodge") +
  theme(
    axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1)
  ) +
    labs(
      x = 'generalhealth',
      y = 'counts',
      title = 'The distribution of generalhealth in different smoking group ')
```

```{r}
test_data_generalhealth_insurancetype = analyse_generalhealth_insurancetype %>% 
  pivot_wider(
  names_from = "insure", 
  values_from = "n")
```

```{r}
test_generalhealth = chisq.test(test_data_generalhealth_insurancetype[-1])

```
According to above chi-square test result We reject the null hypothesis and conclude that there’s at least one helath stutus group’s proportions of insurance type is different from others at 0.05 significant level.


